<!DOCTYPE html>
<html lang="en"><head>
  <link rel="apple-touch-icon" sizes="57x57" href="https://blog.jlandowner.com/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://blog.jlandowner.com/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://blog.jlandowner.com/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog.jlandowner.com/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://blog.jlandowner.com/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://blog.jlandowner.com/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://blog.jlandowner.com/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://blog.jlandowner.com/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://blog.jlandowner.com/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="https://blog.jlandowner.com/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://blog.jlandowner.com/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://blog.jlandowner.com/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://blog.jlandowner.com/favicon/favicon-16x16.png">
  <link rel="manifest" href="https://blog.jlandowner.com/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="https://blog.jlandowner.com/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-170607476-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-170607476-1');
  </script>


  <meta name="generator" content="Hugo 0.72.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="keywords" content="works,Kubernetes,Pod Security Policy,Krew"><meta property="og:title" content="Pod Security Policy Best Practice for multi-tenant cluster" />
<meta property="og:description" content="Pod Security Policy (PSP) is a feature of Kubernetes that enable security policies for Pods in an entire Kubernetes cluster, and allows you to control the availability of Pods based on their security level.
While Pod Security Policy enables effective and powerful policy control in multi-tenant clusters, I think it&rsquo;s a tough job to enforce strict policy control as you expected.
For example, there are some considerations when you apply it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jlandowner.com/posts/pod-security-policy-best-practice/" />
<meta property="article:published_time" content="2020-08-04T01:06:48+09:00" />
<meta property="article:modified_time" content="2020-08-04T01:06:48+09:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pod Security Policy Best Practice for multi-tenant cluster"/>
<meta name="twitter:description" content="Pod Security Policy (PSP) is a feature of Kubernetes that enable security policies for Pods in an entire Kubernetes cluster, and allows you to control the availability of Pods based on their security level.
While Pod Security Policy enables effective and powerful policy control in multi-tenant clusters, I think it&rsquo;s a tough job to enforce strict policy control as you expected.
For example, there are some considerations when you apply it."/>

  <link rel="stylesheet" type="text/css" media="screen" href="https://blog.jlandowner.com/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://blog.jlandowner.com/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://blog.jlandowner.com/css/all.css" />
<title>Pod Security Policy Best Practice for multi-tenant cluster | landscape</title></head>
<body><header>
	
	<div id="avatar">
		<a href="https://blog.jlandowner.com/">
			<img src="/img/avator.png" alt="landscape">
		</a>
	</div>
	
	<div id="titletext"><h2 id="title"><a href="https://blog.jlandowner.com/">landscape</a></h2></div>
	<div id="title-description"><p id="subtitle">Deep think, Easy go.</p><div id=social>
			<nav>
				<ul><li><a href="https://qiita.com/jlandowner"><i title="Qiita" class="icons fas fa-ghost"></i></a></li><li><a href="https://twitter.com/jlandowner_dev"><i title="Twitter" class="icons fab fa-twitter"></i></a></li><li><a href="https://github.com/jlandowner"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="/index.xml"><i title="RSS" class="icons fas fa-rss"></i></a></li></ul>
			</nav>
		</div>
	</div>
	
	<div id="mainmenu">
		<nav>
			<ul>
				
				<li><a href="/">Home</a></li>
				
				<li><a href="/posts">All Posts</a></li>
				
				<li><a href="/about">About</a></li>
				
				<li><a href="/tags">Tags</a></li>
				
			</ul>
		</nav>
	</div>
	
</header>
<main><div class="post">
	
	<div class="author">
	
	</div>
	<div class="post-header">
	
		<div class="meta">
			
			<div class="date">
				<span class="day">04</span>
				<span class="rest">Aug 2020</span>
			</div>
			
		</div>
		
		<div class="matter">
			<h1 class="title">Pod Security Policy Best Practice for multi-tenant cluster</h1>
		</div>
	</div>
	<div class="markdown">
		<p><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security Policy (PSP)</a> is a feature of Kubernetes that enable security policies for Pods in an entire Kubernetes cluster, and allows you to control the availability of Pods based on their security level.</p>
<p>While <code>Pod Security Policy</code> enables effective and powerful policy control in multi-tenant clusters, I think it&rsquo;s a tough job to enforce strict policy control as you expected.</p>
<p>For example, there are some considerations when you apply it.</p>
<p>It&rsquo;s relatively easy to configure like that: <em>for User A to create a privileged pod, but not for User B.</em></p>
<p>But it is not enough for most usecase. The policies should effect not only Users but also the Kubernetes Controllers that actually create Pods.</p>
<h3 id="who-create-pods-">Who create Pods ?</h3>
<p>In usual situations, Users don&rsquo;t create Pod resources directly. They often create a Deployment resource to run Pods.</p>
<p>When you create a Deployment, it is the <code>ReplicaSet Controller</code> that actually creates the Pods.</p>
<p>In this case, it&rsquo;s not enough to enable a policy for the User who created the Deployment;
if the policy is not properly applied to the ReplicaSet Controller as well, the User will be able to run a privileged pod indirectly.</p>
<p>If you are using other controllers such as DaemonSet Controller or custom Kubernetes Operator to create pods, they must be configured properly as well.</p>
<h3 id="configure-psp-for-controllers">Configure PSP for Controllers</h3>
<p>When Controllers create Pods, they use <code>ServiceAccount</code>. So you need to configure that the appropriate PSPs is enabled for the ServiceAccount.</p>
<p>If a <code>ServiceAccount</code> is specified in a Pod template spec in Deployment, the PSP for the ServiceAccount will be effected. It is same as DaemonSet and StatefulSet.</p>
<p>On the other hand, when <code>ServiceAccount</code> is NOT specified in the PodSpec, ServiceAccount named <code>default</code> in the Namspace where the Pod is launched will be used.
<code>default</code> ServiceAccounts exist in every Namespaces by default.</p>
<p>As you see above, it is complicated and cumbersome to apply PSP to each ServiceAccount individually.</p>
<p>Though you may think it is better to prevent Deployment which has privileged Pod specification, it cannot be controlled with PSP.
It is effective and you can do it by implementing validation webhooks on your own, or using an <a href="https://www.openpolicyagent.org/">Open Policy Agent</a>, etc.</p>
<p>However, these are only static validation for the specs.
Powerful PSP&rsquo;s dynamic validations, such as blocking execution by root user in container when container starting, are difficult to implement on other than PSP.</p>
<h3 id="priority-of-psp">Priority of PSP</h3>
<p>There are a few quirks and caveats about the policy priority when multiple PSPs are enabled.</p>
<p>The official documentation states:</p>
<blockquote>
<p>PodSecurityPolicies which allow the pod as-is, without changing defaults or mutating the pod, are preferred. PodSecurityPolicies doesn&rsquo;t matter.</p>
</blockquote>
<blockquote>
<p>If the pod must be defaulted or mutated, the first PSP (ordered by name) to allow the pod is selected.</p>
</blockquote>
<p>AWS IAM Policy, for example, overrides the Deny policy and the Deny has a first priority.
But in the case of PSPs, the policy that allows as-is to takes precedence.</p>
<p>Therefore, I think the first approach is to apply the Deny policy to a large scope in cluster.
And next, apply the policy which allow some privileged feature only to the objects that require privileges.</p>
<p>It&rsquo;s hard to understand of the permissions when multiple PSP is matched.
Therefore it&rsquo;s better to give up on combining policies to create complex privilege controls.</p>
<h3 id="my-best-practice">My Best Practice</h3>
<p>Based on the above, I recommend the following ideas:</p>
<ul>
<li>First of all, create two PSPs. one that allows privileges and one that is restricted.</li>
<li>Next apply the restricted PSP to the entire scope of the cluster like <code>system:authenticated</code> Group.</li>
<li>Then select the privileged Namespaces such as <code>kube-system</code>. And apply the privileged PSP to administrative Groups such as <code>system:master</code> Group and ServiceAccounts in the privileged Namespaces.</li>
<li>If there is some applications that cannot run by the restricted PSP due to its behavior or characteristics, add another PSP.</li>
<li><strong>You should use &ldquo;psp-util&rdquo;, a kubectl plugin to manipulate PSPs (Important ğŸ˜Š )</strong>.</li>
</ul>
<h3 id="step-by-step-to-configure-pod-security-policy-best-practice">Step by step to configure Pod Security Policy Best Practice</h3>
<p>Here&rsquo;s an example of how to set it up as described in My Best Practice.</p>
<h4 id="1-install-the-kubectl-plugin-psp-util"><strong>1. Install the kubectl plugin &ldquo;psp-util&rdquo;</strong></h4>
<p>Pod Security Policy is defined as a kubernetes resource <code>PodSecurityPolicy</code>, which is bound to <code>Group</code> or <code>ServiceAccount</code> using <code>ClusterRole</code> and <code>ClusterRoleBinding</code>.</p>
<p>A Kubectl plugin called <strong><a href="https://github.com/jlandowner/psp-util">&ldquo;psp-util&rdquo;</a></strong> is available ğŸš€ on <a href="https://github.com/kubernetes-sigs/krew"><code>Krew</code></a>, a official plugin manager of Kubectl.</p>
<p>It helps you to manage Pod Security Policy with the associated RBAC resources.</p>
<p>You can view the relations between policies and objects in your cluster, and easily attach and detach the policies.</p>
<p>After <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">installing Krew</a>, you can install <code>psp-util</code> by the following command</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl krew install psp-util
</code></pre></div><h4 id="2-see-the-current-settings"><strong>2. See the current settings</strong></h4>
<p>I will proceed with EKS as an example, since the environment I usually touch is EKS.</p>
<p>First, check current PSPs in cluster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get psp
NAME             PRIV    CAPS   SELINUX    RUNASUSER          FSGROUP     SUPGROUP    READONLYROOTFS   VOLUMES
eks.privileged   true    *      RunAsAny   RunAsAny           RunAsAny    RunAsAny    false            *
</code></pre></div><p>EKS has a PSP named <code>eks.privileged</code> by default. This is a policy that allows all Pods to be run.
<a href="https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/pod-security-policy.html">https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/pod-security-policy.html</a></p>
<p>Next, check the scope the policy effectes.</p>
<p>Run the <code>psp-util tree</code> command. You will see that the PSP is applied to <code>system:authenticated</code> Group.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl psp-util tree
ğŸ“™ PSP eks.privileged
â””â”€â”€ ğŸ“• ClusterRole eks:podsecuritypolicy:privileged
    â””â”€â”€ ğŸ“˜ ClusterRoleBinding eks:podsecuritypolicy:authenticated
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: Group, Name: system:authenticated, Namespace:<span style="color:#f92672">}</span>
</code></pre></div><p><code>system:authenticated</code> Group is the group that all access authenticated by API Server belongs. It means anyone in the cluster is covered by this policy.</p>
<h4 id="3-create-psp"><strong>3. Create PSP</strong></h4>
<p><strong>3-1. Create a privileged PSP</strong></p>
<p>As mentioned above, EKS have a privileged PSP by default.</p>
<p>Here is all permitted PSP configuration in EKS:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:psp-privileged.yaml" data-lang="yaml:psp-privileged.yaml"><span style="color:#66d9ef">apiVersion</span>: policy/v1beta1
<span style="color:#66d9ef">kind</span>: PodSecurityPolicy
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">annotations</span>:
    <span style="color:#66d9ef">kubernetes.io/description</span>: privileged allows full unrestricted access to pod features,
      as if the PodSecurityPolicy controller was not enabled.
    <span style="color:#66d9ef">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span>: <span style="color:#e6db74">&#39;*&#39;</span>
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">eks.amazonaws.com/component</span>: pod-security-policy
    <span style="color:#66d9ef">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#66d9ef">name</span>: eks.privileged
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">allowedCapabilities</span>:
  - <span style="color:#e6db74">&#39;*&#39;</span>
  <span style="color:#66d9ef">fsGroup</span>:
    <span style="color:#66d9ef">rule</span>: RunAsAny
  <span style="color:#66d9ef">hostIPC</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">hostNetwork</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">hostPID</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">hostPorts</span>:
  - <span style="color:#66d9ef">max</span>: <span style="color:#ae81ff">65535</span>
    <span style="color:#66d9ef">min</span>: <span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">privileged</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">runAsUser</span>:
    <span style="color:#66d9ef">rule</span>: RunAsAny
  <span style="color:#66d9ef">seLinux</span>:
    <span style="color:#66d9ef">rule</span>: RunAsAny
  <span style="color:#66d9ef">supplementalGroups</span>:
    <span style="color:#66d9ef">rule</span>: RunAsAny
  <span style="color:#66d9ef">volumes</span>:
  - <span style="color:#e6db74">&#39;*&#39;</span>
</code></pre></div><p>If a privileged PSP does not exist in your cluster, create and apply the above configuration file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f psp-privileged.yaml
</code></pre></div><p>It&rsquo;s also ok to create another PSP that suits your environment if you want a more restricted PSP for the privileged namespace and pods.</p>
<p><strong>3-2. Create a restricted PSP</strong></p>
<p>As a restricted PSP, it&rsquo;s the best to create the PSP in the <a href="https://aws.github.io/aws-eks-best-practices/pods/#recommendations">EKS Best Practices Recommendations</a> published by AWS.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml:psp-restricted.yaml" data-lang="yaml:psp-restricted.yaml"><span style="color:#66d9ef">apiVersion</span>: policy/v1beta1
<span style="color:#66d9ef">kind</span>: PodSecurityPolicy
<span style="color:#66d9ef">metadata</span>:
    <span style="color:#66d9ef">name</span>: restricted
    <span style="color:#66d9ef">annotations</span>:
        <span style="color:#66d9ef">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span>: <span style="color:#e6db74">&#39;docker/default,runtime/default&#39;</span> <span style="color:#75715e"># Remove if seccomp is not enabled</span>
        <span style="color:#66d9ef">apparmor.security.beta.kubernetes.io/allowedProfileNames</span>: <span style="color:#e6db74">&#39;runtime/default&#39;</span> <span style="color:#75715e"># Remove if apparmor is not enabled</span>
        <span style="color:#66d9ef">seccomp.security.alpha.kubernetes.io/defaultProfileName</span>:  <span style="color:#e6db74">&#39;runtime/default&#39;</span> <span style="color:#75715e"># Remove if seccomp is not enabled</span>
        <span style="color:#66d9ef">apparmor.security.beta.kubernetes.io/defaultProfileName</span>:  <span style="color:#e6db74">&#39;runtime/default&#39;</span> <span style="color:#75715e"># Remove if apparmor is not enabled</span>
<span style="color:#66d9ef">spec</span>:
    <span style="color:#66d9ef">privileged</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#75715e"># Required to prevent escalations to root.</span>
    <span style="color:#66d9ef">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#75715e"># This is redundant with non-root + disallow privilege escalation,</span>
    <span style="color:#75715e"># but we can provide it for defense in depth.</span>
    <span style="color:#66d9ef">requiredDropCapabilities</span>:
    - ALL
    <span style="color:#75715e"># Allow core volume types.</span>
    <span style="color:#66d9ef">volumes</span>:
    - <span style="color:#e6db74">&#39;configMap&#39;</span>
    - <span style="color:#e6db74">&#39;emptyDir&#39;</span>
    - <span style="color:#e6db74">&#39;projected&#39;</span>
    - <span style="color:#e6db74">&#39;secret&#39;</span>
    - <span style="color:#e6db74">&#39;downwardAPI&#39;</span>
    <span style="color:#75715e"># Assume that persistentVolumes set up by the cluster admin are safe to use.</span>
    - <span style="color:#e6db74">&#39;persistentVolumeClaim&#39;</span>
    <span style="color:#66d9ef">hostNetwork</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">hostIPC</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">hostPID</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">runAsUser</span>:
        <span style="color:#75715e"># Require the container to run without root privileges.</span>
        <span style="color:#66d9ef">rule</span>: <span style="color:#e6db74">&#39;MustRunAsNonRoot&#39;</span>
    <span style="color:#66d9ef">seLinux</span>:
        <span style="color:#75715e"># This policy assumes the nodes are using AppArmor rather than SELinux.</span>
        <span style="color:#66d9ef">rule</span>: <span style="color:#e6db74">&#39;RunAsAny&#39;</span>
    <span style="color:#66d9ef">supplementalGroups</span>:
        <span style="color:#66d9ef">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
        <span style="color:#66d9ef">ranges</span>:
        <span style="color:#75715e"># Forbid adding the root group.</span>
        - <span style="color:#66d9ef">min</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#66d9ef">max</span>: <span style="color:#ae81ff">65535</span>
    <span style="color:#66d9ef">fsGroup</span>:
        <span style="color:#66d9ef">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
        <span style="color:#66d9ef">ranges</span>:
        <span style="color:#75715e"># Forbid adding the root group.</span>
        - <span style="color:#66d9ef">min</span>: <span style="color:#ae81ff">1</span>
          <span style="color:#66d9ef">max</span>: <span style="color:#ae81ff">65535</span>
    <span style="color:#66d9ef">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">false</span>
</code></pre></div><p>Create an above configuration file and apply it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f psp-restricted.yaml
</code></pre></div><p>If your application is already running in a cluster and you want to define a restriction policy within the limits of the current running app, you can use <a href="https://github.com/sysdiglabs/kube-psp-advisor">kube-psp-advisor</a> maintained by sysdig. It automatically generates the appropriate PSP.</p>
<p>It is also available on Krew.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl krew install advise-psp
</code></pre></div><p>The <code>inspect</code> command automatically generates PSP by given Namespace where the target application is currently running.
The following command creates PSP generated by the inspect result.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl advise-psp inspect --namespace<span style="color:#f92672">=</span>YOUR_NAMESPACE | kubectl apply -f -
</code></pre></div><h4 id="4-apply-psps"><strong>4. Apply PSPs</strong></h4>
<p>Now that we have created a privileged PSP and a restricted PSP.</p>
<p>(In the case of EKS)
Detach a privileged PSP from <code>system:authenticated</code> Group.</p>
<p>psp-util automatically creates ClusterRoleBinding, so just remove the ClusterRoleBinding named <code>eks:podsecuritypolicy:authenticated</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl delete ClusterRoleBinding eks:podsecuritypolicy:authenticated
</code></pre></div><h4 id="4-1-apply-the-restricted-psp"><strong>4-1. Apply the restricted PSP</strong></h4>
<p>To apply the restricted PSP to whole cluster, attach the PSP to <code>system:authenticated</code> Group.</p>
<p>Assuming that you have created a restricted PSP named <code>restricted</code>, Run the following command</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl psp-util attach restricted --group system:authenticated
</code></pre></div><p>See the current situation. ClusterRole and ClusterRoleBinding are automatically created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl psp-util tree
ğŸ“™ PSP eks.privileged
â””â”€â”€ ğŸ“• ClusterRole eks:podsecuritypolicy:privileged

ğŸ“™ PSP restricted
â””â”€â”€ ğŸ“• ClusterRole psp-util.restricted
    â””â”€â”€ ğŸ“˜ ClusterRoleBinding psp-util.restricted
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: Group, Name: system:authenticated, Namespace:<span style="color:#f92672">}</span>
</code></pre></div><h4 id="4-2-apply-the-privileged-psp"><strong>4-2. Apply the privileged PSP</strong></h4>
<p><strong>4-2-1. For Administrative Group</strong></p>
<p>Attach the privileged PSP to <code>system:master</code> Group, an administrative group.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl psp-util attach eks.privileged --group system:master
</code></pre></div><p><strong>4-2-1. For ServiceAccounts in privileged Namspace</strong></p>
<p>Attach the privileged PSP to ServiceAccounts in the privileged Namspace.</p>
<p>This time, I treat Only <code>kube-system</code> namespace as a privileged Namespace.</p>
<p>First, attach the privilege to the <code>default</code> ServiceAccount in kube-system.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl psp-util attach eks.privileged --sa default -n kube-system
</code></pre></div><p>Second, attach the privileged PSP to all ServiceAccounts used by Deployment, DaemonSet and StatefulSet in the <code>kube-system</code>.</p>
<p>Since most of the workloads in the <code>kube-system</code> require access to the API Server, they each have their own ServiceAccounts.</p>
<p>Run the following Bash Oneliners to apply the privileged PSP to them all at once.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Namespace<span style="color:#f92672">=</span>kube-system
<span style="color:#66d9ef">for</span> v in <span style="color:#e6db74">`</span>kubectl get deploy -o custom-columns<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ServiceAccount:spec.template.spec.serviceAccount&#34;</span> --no-headers -n $Namespace | awk <span style="color:#e6db74">&#39;{if ($1!=&#34;&lt;none&gt;&#34;) print $1}&#39;</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span> kubectl psp-util attach eks.privileged --sa $v -n $Namespace ;<span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">for</span> v in <span style="color:#e6db74">`</span>kubectl get ds     -o custom-columns<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ServiceAccount:spec.template.spec.serviceAccount&#34;</span> --no-headers -n $Namespace | awk <span style="color:#e6db74">&#39;{if ($1!=&#34;&lt;none&gt;&#34;) print $1}&#39;</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span> kubectl psp-util attach eks.privileged --sa $v -n $Namespace ;<span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">for</span> v in <span style="color:#e6db74">`</span>kubectl get sts    -o custom-columns<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ServiceAccount:spec.template.spec.serviceAccount&#34;</span> --no-headers -n $Namespace | awk <span style="color:#e6db74">&#39;{if ($1!=&#34;&lt;none&gt;&#34;) print $1}&#39;</span><span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span> kubectl psp-util attach eks.privileged --sa $v -n $Namespace ;<span style="color:#66d9ef">done</span>
</code></pre></div><p>In addition, if you want to apply the privileged PSP to ServiceAccounts in other Namespace, change the above commands and execute it.</p>
<h4 id="5-finished"><strong>5. Finished</strong></h4>
<p>That&rsquo;s all. Here is the result of the configuration so far.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl psp-util tree      
ğŸ“™ PSP eks.privileged
â””â”€â”€ ğŸ“• ClusterRole eks:podsecuritypolicy:privileged
â””â”€â”€ ğŸ“• ClusterRole psp-util.eks.privileged
    â””â”€â”€ ğŸ“˜ ClusterRoleBinding psp-util.eks.privileged
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: Group, Name: system:master, Namespace: <span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: default, Namespace: kube-system<span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: alb-ingress-controller, Namespace: kube-system<span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: coredns, Namespace: kube-system<span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: aws-node, Namespace: kube-system<span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: kube-proxy, Namespace: kube-system<span style="color:#f92672">}</span>
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: ServiceAccount, Name: node-problem-detector, Namespace: kube-system<span style="color:#f92672">}</span>

ğŸ“™ PSP restricted
â””â”€â”€ ğŸ“• ClusterRole psp-util.restricted
    â””â”€â”€ ğŸ“˜ ClusterRoleBinding psp-util.restricted
        â””â”€â”€ ğŸ“— Subject<span style="color:#f92672">{</span>Kind: Group, Name: system:authenticated, Namespace: <span style="color:#f92672">}</span>
</code></pre></div><p>If you want another PSP between privileged and restricted PSPs, you should create a dedicated PSP and apply it in the same way as you apply the privileged PSP.</p>
<p>However the privileged PSP has a first priority when you apply it to which a privileged PSP has been applied.
So verify and apply it carefully.</p>
<p>After doing the settings shown above, I recommend you to check whether you can&rsquo;t create a privileged Pod as a general User, or whether you can&rsquo;t start privileged Pods from Deployment outside of <code>kube-system</code> and so on.</p>
<p>It is difficult to understand the functions until you actually configure and run.</p>
<p>Have a good k8s experience ğŸ‘</p>

	</div>
	
	
	
	
	
		
	
	
	
	<div class="tags">
		<div class="taxosfloating_left">
			<p>Tags</p>
		</div>
		<div class="termsfloating_right">
			<p>
			
			
			
			
			
			
			
			<a href="https://blog.jlandowner.com/tags/krew/"> krew </a>
			
			
			
			
			
			<a href="https://blog.jlandowner.com/tags/kubernetes/"> kubernetes </a>
			
			
			
			
			
			
			
			
			
			
			
			<a href="https://blog.jlandowner.com/tags/pod-security-policy/"> pod-security-policy </a>
			
			
			
			
			
			<a href="https://blog.jlandowner.com/tags/works/"> works </a>
			
			
			
			
			
			</p>
		</div>
		<div class="clearit"></div>
		
		
		
		
		
	</div></div>

  </main>
<footer>
	 Â© 2020 jlandowner | <a href="https://github.com/dataCobra/hugo-vitae">Vitae</a> theme for <a href="https://gohugo.io">Hugo</a> 
	
	
	
</footer>


</body>
</html>
